<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elixir W&B & Performance (Unofficial)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --bg-card-alt: #02081c;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --ok: #22c55e;
      --border: #1f2937;
      --radius: 10px;
      --shadow: 0 16px 35px rgba(15, 23, 42, 0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1.4rem 1rem 0.6rem;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.5rem, 4vw, 2rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    header p {
      margin: 0.35rem 0 0;
      color: var(--muted);
      font-size: 0.85rem;
    }

    header p strong {
      color: #facc15;
      font-weight: 600;
    }

    main {
      width: 100%;
      max-width: 1180px;
      margin: 0 auto 2.5rem;
      padding: 0 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.6rem;
    }

    .section-block {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .section-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .section-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 1.1rem;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .section-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, var(--bg-card-alt), var(--bg-card));
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1.15rem 1.3rem 1.35rem;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.14), transparent 55%);
      opacity: 0.4;
      pointer-events: none;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.4rem;
      font-size: 1rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .card small {
      display: block;
      color: var(--muted);
      font-size: 0.78rem;
      margin-bottom: 0.7rem;
      position: relative;
      z-index: 1;
    }

    .grid,
    .grid-3 {
      display: grid;
      gap: 0.7rem 0.9rem;
    }

    .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    @media (max-width: 640px) {
      .grid,
      .grid-3 { grid-template-columns: minmax(0, 1fr); }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      position: relative;
      z-index: 1;
    }

    label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    input,
    select {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.42rem 0.7rem;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      width: 100%;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
      background: rgba(15, 23, 42, 1);
    }

    input[readonly] { opacity: 0.7; }

    .inline-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.3rem;
    }

    .inline-warning {
      font-size: 0.75rem;
      color: var(--danger);
      margin-top: 0.3rem;
    }

    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      margin-top: 0.9rem;
      position: relative;
      z-index: 1;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.8);
      padding: 0.45rem 1.1rem;
      font-size: 0.85rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 1));
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    button span { font-size: 1rem; }

    button:hover {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 1));
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.16rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 0.73rem;
      letter-spacing: 0.11em;
      text-transform: uppercase;
      color: var(--muted);
      background: radial-gradient(circle at left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.8));
    }

    .pill.ok {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .pill.bad {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .results-block {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
      margin-top: 0.4rem;
      font-size: 0.83rem;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 640px) {
      .results-block { grid-template-columns: minmax(0, 1fr); }
    }

    .res-card {
      padding: 0.55rem 0.7rem;
      border-radius: 0.75rem;
      background: radial-gradient(circle at top left, var(--accent-soft), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .res-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .res-main { font-size: 0.92rem; }

    .res-sub {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 0.2rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem 1.1rem;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .row strong { font-size: 0.86rem; }

    .muted {
      color: var(--muted);
      font-size: 0.75rem;
      margin-top: 0.4rem;
      position: relative;
      z-index: 1;
    }

    canvas { max-width: 100%; margin-top: 0.3rem; }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.9rem;
      margin-top: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .charts-grid h3 {
      margin: 0.4rem 0 0.2rem;
      font-size: 0.85rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* Runway diagram */
    .runway-wrapper {
      margin-top: 0.7rem;
      position: relative;
      z-index: 1;
    }

    .runway-bar {
      position: relative;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
      overflow: hidden;
    }

    .runway-marker {
      position: absolute;
      top: 3px;
      bottom: 3px;
      border-radius: 999px;
      opacity: 0.85;
    }

    .runway-marker.overrun {
      background: linear-gradient(90deg, #7f1d1d, #b91c1c);
    }

    .runway-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.9rem;
      font-size: 0.75rem;
      margin-top: 0.35rem;
      color: var(--muted);
    }

    .leg-swatch {
      display: inline-block;
      width: 10px;
      height: 6px;
      border-radius: 999px;
      margin-right: 0.25rem;
    }

    .sw-to-run { background: #38bdf8; }
    .sw-to-dist { background: #a855f7; }
    .sw-ldg-run { background: #22c55e; }
    .sw-ldg-dist { background: #f97316; }

    .fact-status-ok   { color: var(--ok); }
    .fact-status-bad  { color: var(--danger); }

    .summary-line-ok { color: var(--ok); }
    .summary-line-bad { color: var(--danger); }

  </style>
</head>
<body>
  <header>
    <h1>Elixir W&amp;B + Performance</h1>
    <p>Unofficial helper based on your AFM + ops factors. <strong>AFM and your Ops Manual are always the authority.</strong></p>
  </header>

  <main>
    <!-- =============== W&B SECTION =============== -->
    <section class="section-block">
      <div class="section-title">Weight &amp; Balance</div>
      <div class="section-grid">
        <!-- Inputs -->
        <section class="card">
          <h2>Loading</h2>
          <small>Select a registration to auto-fill empty mass &amp; CG, then adjust loading.</small>

          <div class="grid">
            <div class="field">
              <label for="regSelect">Registration</label>
              <select id="regSelect">
                <option value="custom" selected>Custom / manual</option>
                <option value="F-HEGB">F-HEGB</option>
                <option value="F-HEGC">F-HEGC</option>
                <option value="F-HLDF">F-HLDF</option>
                <option value="F-HLDG">F-HLDG</option>
                <option value="F-HTGH">F-HTGH</option>
                <option value="F-HXCD">F-HXCD</option>
              </select>
            </div>
            <div class="field">
              <label>Reg info</label>
              <div class="inline-note" id="regInfo">
                Select an Elixir registration to fill empty mass &amp; CG from the school list.
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top:0.6rem">
            <div class="field">
              <label for="emptyWeight">Empty weight (kg)</label>
              <input id="emptyWeight" type="number" inputmode="decimal" value="360" />
            </div>
            <div class="field">
              <label for="emptyArm">Empty CG (mm)</label>
              <input id="emptyArm" type="number" inputmode="decimal" value="673" />
            </div>
          </div>

          <div class="grid-3" style="margin-top:0.75rem">
            <div class="field">
              <label for="pilotWt">Pilot (kg)</label>
              <input id="pilotWt" type="number" inputmode="decimal" value="95" />
            </div>
            <div class="field">
              <label for="pilotArm">Pilot arm (mm)</label>
              <select id="pilotArm">
                <option value="1050">Fwd (1050)</option>
                <option value="1150" selected>Aft (1150)</option>
              </select>
            </div>
            <div class="field">
              <label for="paxWt">Passenger (kg)</label>
              <input id="paxWt" type="number" inputmode="decimal" value="90" />
            </div>
            <div class="field">
              <label for="paxArm">Passenger arm (mm)</label>
              <select id="paxArm">
                <option value="1050">Fwd (1050)</option>
                <option value="1150" selected>Aft (1150)</option>
              </select>
            </div>
            <div class="field">
              <label for="bagWt">Baggage (kg)</label>
              <input id="bagWt" type="number" inputmode="decimal" value="0" />
              <div id="bagWarn" class="inline-warning" style="display:none;"></div>
            </div>
            <div class="field">
              <label>Baggage arm (mm)</label>
              <input type="number" value="1580" readonly />
            </div>
          </div>

          <div class="grid" style="margin-top:0.75rem">
            <div class="field">
              <label for="fuelL">Fuel (L usable)</label>
              <input id="fuelL" type="number" inputmode="decimal" value="60" />
              <div id="fuelWarn" class="inline-warning" style="display:none;"></div>
            </div>
            <div class="field">
              <label for="fuelDensity">Fuel density (kg/L)</label>
              <input id="fuelDensity" type="number" inputmode="decimal" value="0.72" step="0.01" />
            </div>
          </div>

          <div class="grid" style="margin-top:0.4rem">
            <div class="field">
              <label>Fuel weight (kg)</label>
              <input id="fuelKg" type="number" readonly />
            </div>
            <div class="field">
              <label>Notes</label>
              <div class="inline-note">
                AFM limits: fuel ≤ 72&nbsp;kg / 100&nbsp;L, baggage ≤ 25&nbsp;kg, MTOW/MLW 630&nbsp;kg, CG envelope as per AFM.
              </div>
            </div>
          </div>

          <div class="row">
            <span class="pill" id="wbStatusPill">Awaiting calculation</span>
          </div>

          <div class="results-block">
            <div class="res-card">
              <div class="res-title">Departure</div>
              <div class="res-main">
                <strong><span id="tow"></span> kg</strong> at CG
                <strong><span id="cg"></span> mm</strong>
              </div>
              <div class="res-sub">
                Checked against AFM mass–CG envelope &amp; 630&nbsp;kg limit.
              </div>
            </div>
            <div class="res-card">
              <div class="res-title">Arrival (fuel burned)</div>
              <div class="res-main">
                <strong><span id="lw"></span> kg</strong> at CG
                <strong><span id="cgArr"></span> mm</strong>
              </div>
              <div class="res-sub">
                Fuel set to 0&nbsp;kg for arrival point.
              </div>
            </div>
          </div>

          <div class="button-row">
            <button id="calcBtn"><span>⟲</span> Calculate &amp; update</button>
          </div>
        </section>

        <!-- CG envelope graph -->
        <section class="card">
          <h2>Loading Verification</h2>
          <small>Mass–CG envelope from AFM: points (430/720, 500/720, 630/800, 630/860).</small>

          <canvas id="cgChart" height="260"></canvas>

          <p class="muted">
            Blue area = AFM loading envelope. Red markers show current departure and arrival.
            Both must lie inside the blue area and within 430–630&nbsp;kg.
          </p>
        </section>
      </div>
    </section>

    <!-- =============== PERFORMANCE SECTION =============== -->
    <section class="section-block">
      <div class="section-title">Performance</div>
      <div class="section-grid">
        <!-- Atmosphere, runway, wind + numeric perf -->
        <section class="card">
          <h2>Conditions &amp; Runway</h2>
          <small>AFM §5.3/5.4 distances (630&nbsp;kg, no wind, level hard runway) + school factors.</small>

          <div class="grid">
            <div class="field">
              <label for="fieldElev">Field elevation (ft)</label>
              <input id="fieldElev" type="number" inputmode="decimal" value="200" />
            </div>
            <div class="field">
              <label for="oat">OAT at field (°C)</label>
              <input id="oat" type="number" inputmode="decimal" value="15" />
            </div>
          </div>

          <div class="grid" style="margin-top:0.6rem">
            <div class="field">
              <label>Pressure altitude (ft)</label>
              <input id="pa" type="number" readonly />
            </div>
            <div class="field">
              <label>ISA deviation (°C)</label>
              <input id="isaDev" type="number" readonly />
            </div>
          </div>

          <div class="grid" style="margin-top:0.75rem">
            <div class="field">
              <label for="runwayLen">Runway length TORA/TODA/ASDA/LDA (m)</label>
              <input id="runwayLen" type="number" inputmode="decimal" value="1330" />
              <div class="inline-note">
                Default: RWY 13/31 full length declared distances 1330&nbsp;m.
              </div>
            </div>
            <div class="field">
              <label for="surface">Surface</label>
              <select id="surface">
                <option value="hard">Hard / paved</option>
                <option value="grass_dry">Grass – dry</option>
                <option value="grass_wet">Grass – wet</option>
              </select>
            </div>
          </div>

          <div class="grid" style="margin-top:0.75rem">
            <div class="field">
              <label for="rwHeading">Runway heading (°)</label>
              <input id="rwHeading" type="number" inputmode="decimal" value="137" />
            </div>
            <div class="field">
              <label for="windDir">Wind direction (° / from)</label>
              <input id="windDir" type="number" inputmode="decimal" value="137" />
            </div>
          </div>

          <div class="grid" style="margin-top:0.75rem">
            <div class="field">
              <label for="windSpd">Wind speed (kt)</label>
              <input id="windSpd" type="number" inputmode="decimal" value="0" />
            </div>
            <div class="field">
              <label>Wind components</label>
              <div class="inline-note" id="windComponents">
                Headwind 0 kt, crosswind 0 kt (max demonstrated 18 kt).
              </div>
              <div class="inline-warning" id="windLimitWarn" style="display:none;"></div>
            </div>
          </div>

          <div class="results-block">
            <div class="res-card">
              <div class="res-title">AFM Take-off (unfactored)</div>
              <div class="res-main">
                Run: <strong><span id="toRun"></span> m</strong>,
                15&nbsp;m: <strong><span id="toDist"></span> m</strong>
              </div>
              <div class="res-sub">
                AFM: flaps T/O, 630&nbsp;kg, no wind, level hard surface. Grass factors applied to run only.
              </div>
            </div>
            <div class="res-card">
              <div class="res-title">AFM Landing (unfactored)</div>
              <div class="res-main">
                Run: <strong><span id="ldgRun"></span> m</strong>,
                15&nbsp;m: <strong><span id="ldgDist"></span> m</strong>
              </div>
              <div class="res-sub">
                AFM: flaps LDG, -3° approach, 630&nbsp;kg, no wind, dry hard surface.
              </div>
            </div>
          </div>

          <!-- Regulatory / factored -->
          <div class="results-block">
            <div class="res-card">
              <div class="res-title">Regulatory – Take-off</div>
              <div class="res-main">
                <div>Required TORA (no stopway, AFM 15 m × 1.25): <strong><span id="reqTora125"></span> m</strong></div>
                <div>Status: <span id="reqTora125Status"></span></div>
                <hr style="border:none;border-top:1px solid rgba(148,163,184,0.3);margin:0.4rem 0;">
                <div>With stopway/clearway available:</div>
                <div>- TORA ≥ AFM run (<span id="reqToraRun"></span> m)</div>
                <div>- TODA ≥ 1.15 × AFM distance (<span id="reqToda115"></span> m)</div>
                <div>- ASDA ≥ 1.3 × AFM run (<span id="reqAsda130"></span> m)</div>
                <div>Status: <span id="reqStopwayStatus"></span></div>
              </div>
              <div class="res-sub">
                From your performance notes: 1.25 factor if no stopway; 1.15/1.3 factors when stopway/clearway / ASDA used.
              </div>
            </div>

            <div class="res-card">
              <div class="res-title">Regulatory – Landing</div>
              <div class="res-main">
                <div>Required LDA dry (AFM 15 m ÷ 0.7): <strong><span id="reqLdaDry"></span> m</strong></div>
                <div>Status: <span id="reqLdaDryStatus"></span></div>
                <hr style="border:none;border-top:1px solid rgba(148,163,184,0.3);margin:0.4rem 0;">
                <div>Required LDA wet (AFM 15 m ×1.15 ÷0.7): <strong><span id="reqLdaWet"></span> m</strong></div>
                <div>Status: <span id="reqLdaWetStatus"></span></div>
              </div>
              <div class="res-sub">
                Ops notes: dry within 70% of LDA; if wet, multiply AFM distance by 1.15 first.
              </div>
            </div>
          </div>

          <div class="row">
            <div>Rate of climb (max continuous, 140&nbsp;km/h):</div>
            <div>Vz ≈ <strong><span id="roc"></span> ft/min</strong></div>
          </div>

          <p class="muted">
            AFM performance tables are no-wind, level hard runway at 630&nbsp;kg.
            This tool adds your factors but does not automatically apply 50% headwind / 150% tailwind corrections to distances – keep margins generous.
          </p>
        </section>

        <!-- Runway diagram + perf graphs -->
        <section class="card">
          <h2>Runway Diagram &amp; Graphs</h2>
          <small>Visual comparison of AFM distances vs declared runway plus AFM-style graphs.</small>

          <div class="runway-wrapper">
            <div class="runway-bar" id="runwayBar">
              <div class="runway-marker" id="barToRun"  style="background:#38bdf8;"></div>
              <div class="runway-marker" id="barToDist" style="background:#a855f7;"></div>
              <div class="runway-marker" id="barLdgRun" style="background:#22c55e;"></div>
              <div class="runway-marker" id="barLdgDist" style="background:#f97316;"></div>
            </div>
            <div class="runway-legend">
              <span><span class="leg-swatch sw-to-run"></span>Take-off run</span>
              <span><span class="leg-swatch sw-to-dist"></span>Take-off distance to 15&nbsp;m</span>
              <span><span class="leg-swatch sw-ldg-run"></span>Landing run</span>
              <span><span class="leg-swatch sw-ldg-dist"></span>Landing distance from 15&nbsp;m</span>
            </div>
          </div>

          <div class="charts-grid">
            <div>
              <h3>Take-off vs pressure altitude</h3>
              <canvas id="toChart"></canvas>
            </div>
            <div>
              <h3>Landing vs pressure altitude</h3>
              <canvas id="ldgChart"></canvas>
            </div>
            <div>
              <h3>Rate of climb vs pressure altitude</h3>
              <canvas id="rocChart"></canvas>
            </div>
          </div>

          <p class="muted">
            Markers show current PA / ISA deviation. Curves from AFM tables at ISA, ISA+10&nbsp;°C, ISA+20&nbsp;°C (630&nbsp;kg).
          </p>
        </section>
      </div>
    </section>

    <!-- =============== OPERATIONAL SUMMARY =============== -->
    <section class="section-block">
      <div class="section-title">Operational Summary</div>
      <section class="card">
        <h2>Operational Summary</h2>
        <small>High-level GO/NO-GO view from AFM, weight &amp; balance, runway and wind checks.</small>

        <div class="res-card" style="margin-bottom:0.5rem;">
          <div class="res-title">Weight &amp; balance</div>
          <div id="sumWb" class="res-main"></div>
        </div>

        <div class="res-card" style="margin-bottom:0.5rem;">
          <div class="res-title">Take-off performance</div>
          <div id="sumPerfTo" class="res-main"></div>
        </div>

        <div class="res-card" style="margin-bottom:0.5rem;">
          <div class="res-title">Landing performance</div>
          <div id="sumPerfLdg" class="res-main"></div>
        </div>

        <div class="res-card" style="margin-bottom:0.5rem;">
          <div class="res-title">Wind &amp; runway</div>
          <div id="sumWind" class="res-main" style="margin-bottom:0.25rem;"></div>
          <div id="sumRunway" class="res-main"></div>
        </div>

        <div class="row" style="margin-top:0.7rem;">
          <span class="pill" id="sumPill">Decision: pending</span>
        </div>

        <p class="muted">
          This summary is for quick cross-check only. Final decision must always reference the AFM, current NOTAMs,
          local procedures and the HT/CFI when in doubt.
        </p>
      </section>
    </section>
  </main>

  <script>
    // ------- Registration data -------
    const REG_DATA = {
      "F-HEGB": { weight: 416.3, cg: 707 },
      "F-HEGC": { weight: 415.1, cg: 698 },
      "F-HLDF": { weight: 417.2, cg: 710 },
      "F-HLDG": { weight: 416.6, cg: 707 },
      "F-HTGH": { weight: 414.9, cg: 710 },
      "F-HXCD": { weight: 415.0, cg: 693 },
    };

    // ------- AFM DATA (630 kg, no wind, hard) -------
    const ALT_GRID_TOLD = [0, 2000, 4000, 6000]; // ft
    const TEMP_DEV_GRID = [0, 10, 20]; // ISA, ISA+10, ISA+20

    // Take-off table: [run_ISA, dist_ISA, run_ISA+10, dist_ISA+10, run_ISA+20, dist_ISA+20] m
    const TO_TABLE = {
      0:    [250, 445, 270, 480, 290, 517],
      2000: [292, 522, 315, 564, 339, 607],
      4000: [339, 608, 366, 657, 394, 708],
      6000: [398, 716, 430, 774, 464, 836],
    };

    // Landing table: [run_ISA, dist_ISA, run_ISA+10, dist_ISA+10, run_ISA+20, dist_ISA+20] m
    const LDG_TABLE = {
      0:    [225, 575, 233, 583, 241, 591],
      2000: [239, 589, 247, 597, 255, 605],
      4000: [253, 603, 262, 612, 271, 621],
      6000: [269, 619, 279, 629, 289, 639],
    };

    // Grass factors
    const GRASS_FACTORS = {
      hard:      { to: 1.0, ldg: 1.0 },
      grass_dry: { to: 1.2, ldg: 1.2 },
      grass_wet: { to: 1.3, ldg: 1.6 },
    };

    // Rate of climb table (ISA, ISA+10, ISA+20)
    const ALT_GRID_ROC = [0, 2000, 4000, 6000, 8000, 10000, 12000, 14000, 16000];
    const ROC_TABLE = {
      0:     [1040, 990, 950],
      2000:  [930, 880, 840],
      4000:  [820, 780, 740],
      6000:  [710, 670, 630],
      8000:  [600, 570, 530],
      10000: [500, 460, 430],
      12000: [390, 350, 320],
      14000: [280, 250, 220],
      16000: [170, 140, 110],
    };

    const MAX_XWIND = 18; // kt max demonstrated crosswind
    const MAX_WIND  = 40; // departure not permitted if wind > 40 kt

    // CG envelope polygon: {cg_mm (x), mass_kg (y)}
    const CG_POLY = [
      { x: 720, y: 430 },
      { x: 720, y: 500 },
      { x: 800, y: 630 },
      { x: 860, y: 630 },
      { x: 860, y: 430 },
    ];

    const CG_MIN_MASS = 430;
    const MAX_MASS     = 630;
    const MAX_FUEL_KG  = 72;
    const MAX_FUEL_L   = 100;
    const MAX_BAG_KG   = 25;
    const CG_MIN       = 720;
    const CG_MAX       = 860;

    // Helpers
    function clamp(x, min, max) { return Math.max(min, Math.min(max, x)); }

    function lerp(x, x0, x1, y0, y1) {
      if (x1 === x0) return y0;
      const t = (x - x0) / (x1 - x0);
      return y0 + t * (y1 - y0);
    }

    function round(x, decimals = 0) {
      const f = Math.pow(10, decimals);
      return Math.round(x * f) / f;
    }

    // Point-in-polygon (ray casting)
    function pointInPoly(px, py, poly) {
      let inside = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i].x, yi = poly[i].y;
        const xj = poly[j].x, yj = poly[j].y;
        const intersect =
          yi > py !== yj > py &&
          px < ((xj - xi) * (py - yi)) / ((yj - yi) || 1e-9) + xi;
        if (intersect) inside = !inside;
      }
      return inside;
    }

    // Interpolate takeoff/landing table
    function interpTOLD(pa, isaDev, table) {
      const paClamped = clamp(pa, ALT_GRID_TOLD[0], ALT_GRID_TOLD[ALT_GRID_TOLD.length - 1]);
      const devClamped = clamp(isaDev, TEMP_DEV_GRID[0], TEMP_DEV_GRID[TEMP_DEV_GRID.length - 1]);

      let tIdx0 = 0;
      for (let i = 0; i < TEMP_DEV_GRID.length - 1; i++) {
        if (devClamped >= TEMP_DEV_GRID[i] && devClamped <= TEMP_DEV_GRID[i + 1]) {
          tIdx0 = i;
          break;
        }
      }
      const tIdx1 = tIdx0 + 1;
      const t0 = TEMP_DEV_GRID[tIdx0];
      const t1 = TEMP_DEV_GRID[tIdx1];

      let aIdx0 = 0;
      for (let i = 0; i < ALT_GRID_TOLD.length - 1; i++) {
        if (paClamped >= ALT_GRID_TOLD[i] && paClamped <= ALT_GRID_TOLD[i + 1]) {
          aIdx0 = i;
          break;
        }
      }
      const aIdx1 = aIdx0 + 1;
      const a0 = ALT_GRID_TOLD[aIdx0];
      const a1 = ALT_GRID_TOLD[aIdx1];

      function valAt(alt, tempIdx) {
        const row = table[alt];
        const run = row[tempIdx * 2];
        const dist = row[tempIdx * 2 + 1];
        return { run, dist };
      }

      const v_a0_t0 = valAt(a0, tIdx0);
      const v_a0_t1 = valAt(a0, tIdx1);
      const v_a1_t0 = valAt(a1, tIdx0);
      const v_a1_t1 = valAt(a1, tIdx1);

      const run_a0 = lerp(devClamped, t0, t1, v_a0_t0.run, v_a0_t1.run);
      const dist_a0 = lerp(devClamped, t0, t1, v_a0_t0.dist, v_a0_t1.dist);
      const run_a1 = lerp(devClamped, t0, t1, v_a1_t0.run, v_a1_t1.run);
      const dist_a1 = lerp(devClamped, t0, t1, v_a1_t0.dist, v_a1_t1.dist);

      const run = lerp(paClamped, a0, a1, run_a0, run_a1);
      const dist = lerp(paClamped, a0, a1, dist_a0, dist_a1);
      return { run, dist };
    }

    function interpRoc(pa, isaDev) {
      const paClamped = clamp(pa, ALT_GRID_ROC[0], ALT_GRID_ROC[ALT_GRID_ROC.length - 1]);
      const devClamped = clamp(isaDev, TEMP_DEV_GRID[0], TEMP_DEV_GRID[TEMP_DEV_GRID.length - 1]);

      let tIdx0 = 0;
      for (let i = 0; i < TEMP_DEV_GRID.length - 1; i++) {
        if (devClamped >= TEMP_DEV_GRID[i] && devClamped <= TEMP_DEV_GRID[i + 1]) {
          tIdx0 = i;
          break;
        }
      }
      const tIdx1 = tIdx0 + 1;
      const t0 = TEMP_DEV_GRID[tIdx0];
      const t1 = TEMP_DEV_GRID[tIdx1];

      let aIdx0 = 0;
      for (let i = 0; i < ALT_GRID_ROC.length - 1; i++) {
        if (paClamped >= ALT_GRID_ROC[i] && paClamped <= ALT_GRID_ROC[i + 1]) {
          aIdx0 = i;
          break;
        }
      }
      const aIdx1 = aIdx0 + 1;
      const a0 = ALT_GRID_ROC[aIdx0];
      const a1 = ALT_GRID_ROC[aIdx1];

      function rocAt(alt, tempIdx) {
        const row = ROC_TABLE[alt];
        return row[tempIdx];
      }

      const v_a0_t0 = rocAt(a0, tIdx0);
      const v_a0_t1 = rocAt(a0, tIdx1);
      const v_a1_t0 = rocAt(a1, tIdx0);
      const v_a1_t1 = rocAt(a1, tIdx1);

      const roc_a0 = lerp(devClamped, t0, t1, v_a0_t0, v_a0_t1);
      const roc_a1 = lerp(devClamped, t0, t1, v_a1_t0, v_a1_t1);

      return lerp(paClamped, a0, a1, roc_a0, roc_a1);
    }

    // ------- Charts -------
    let cgChart, toChart, ldgChart, rocChart;
    let cgDepDataset, cgArrDataset, toPointDataset, ldgPointDataset, rocPointDataset;

    function buildCGChart() {
      const ctx = document.getElementById("cgChart").getContext("2d");
      const polyPoints = [...CG_POLY, CG_POLY[0]].map(p => ({ x: p.x, y: p.y }));

      cgDepDataset = {
        type: "scatter",
        label: "Departure",
        data: [],
        pointRadius: 5,
        pointHoverRadius: 6,
      };

      cgArrDataset = {
        type: "scatter",
        label: "Arrival",
        data: [],
        pointRadius: 5,
        pointHoverRadius: 6,
      };

      cgChart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "AFM envelope",
              data: polyPoints,
              tension: 0,
              fill: true,
            },
            cgDepDataset,
            cgArrDataset,
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "CG position (mm from firewall)" },
              min: 710,
              max: 870,
            },
            y: {
              title: { display: true, text: "Mass (kg)" },
              min: 420,
              max: 650,
            },
          },
          plugins: { legend: { labels: { boxWidth: 10 } } },
        },
      });
    }

    function buildPerfCharts() {
      const ctxTo = document.getElementById("toChart").getContext("2d");
      const ctxLdg = document.getElementById("ldgChart").getContext("2d");
      const ctxRoc = document.getElementById("rocChart").getContext("2d");

      const toISA_run = [], toISA_dist = [];
      const toISA10_run = [], toISA10_dist = [];
      const toISA20_run = [], toISA20_dist = [];

      ALT_GRID_TOLD.forEach(alt => {
        const row = TO_TABLE[alt];
        toISA_run.push({ x: alt, y: row[0] });
        toISA_dist.push({ x: alt, y: row[1] });
        toISA10_run.push({ x: alt, y: row[2] });
        toISA10_dist.push({ x: alt, y: row[3] });
        toISA20_run.push({ x: alt, y: row[4] });
        toISA20_dist.push({ x: alt, y: row[5] });
      });

      const ldgISA_run = [], ldgISA_dist = [];
      const ldgISA10_run = [], ldgISA10_dist = [];
      const ldgISA20_run = [], ldgISA20_dist = [];

      ALT_GRID_TOLD.forEach(alt => {
        const row = LDG_TABLE[alt];
        ldgISA_run.push({ x: alt, y: row[0] });
        ldgISA_dist.push({ x: alt, y: row[1] });
        ldgISA10_run.push({ x: alt, y: row[2] });
        ldgISA10_dist.push({ x: alt, y: row[3] });
        ldgISA20_run.push({ x: alt, y: row[4] });
        ldgISA20_dist.push({ x: alt, y: row[5] });
      });

      const rocISA = [], rocISA10 = [], rocISA20 = [];
      ALT_GRID_ROC.forEach(alt => {
        const row = ROC_TABLE[alt];
        rocISA.push({ x: alt, y: row[0] });
        rocISA10.push({ x: alt, y: row[1] });
        rocISA20.push({ x: alt, y: row[2] });
      });

      toPointDataset = {
        type: "scatter",
        label: "Your condition",
        data: [],
        yAxisID: "y1",
        pointRadius: 5,
        pointHoverRadius: 6,
      };

      toChart = new Chart(ctxTo, {
        type: "line",
        data: {
          datasets: [
            { label: "Run ISA", data: toISA_run, tension: 0.2, yAxisID: "y1" },
            { label: "Run ISA+10", data: toISA10_run, tension: 0.2, yAxisID: "y1" },
            { label: "Run ISA+20", data: toISA20_run, tension: 0.2, yAxisID: "y1" },
            {
              label: "15 m dist ISA",
              data: toISA_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            {
              label: "15 m dist ISA+10",
              data: toISA10_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            {
              label: "15 m dist ISA+20",
              data: toISA20_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            toPointDataset,
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { type: "linear", title: { display: true, text: "Pressure altitude (ft)" } },
            y1: { position: "left", title: { display: true, text: "T/O run (m)" } },
            y2: {
              position: "right",
              title: { display: true, text: "T/O distance to 15 m (m)" },
              grid: { drawOnChartArea: false },
            },
          },
          plugins: { legend: { labels: { boxWidth: 10 } } },
        },
      });

      ldgPointDataset = {
        type: "scatter",
        label: "Your condition",
        data: [],
        yAxisID: "y1",
        pointRadius: 5,
        pointHoverRadius: 6,
      };

      ldgChart = new Chart(ctxLdg, {
        type: "line",
        data: {
          datasets: [
            { label: "Run ISA", data: ldgISA_run, tension: 0.2, yAxisID: "y1" },
            { label: "Run ISA+10", data: ldgISA10_run, tension: 0.2, yAxisID: "y1" },
            { label: "Run ISA+20", data: ldgISA20_run, tension: 0.2, yAxisID: "y1" },
            {
              label: "15 m dist ISA",
              data: ldgISA_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            {
              label: "15 m dist ISA+10",
              data: ldgISA10_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            {
              label: "15 m dist ISA+20",
              data: ldgISA20_dist,
              borderDash: [4, 3],
              tension: 0.2,
              yAxisID: "y2",
            },
            ldgPointDataset,
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { type: "linear", title: { display: true, text: "Pressure altitude (ft)" } },
            y1: { position: "left", title: { display: true, text: "Landing run (m)" } },
            y2: {
              position: "right",
              title: { display: true, text: "Landing distance 15 m (m)" },
              grid: { drawOnChartArea: false },
            },
          },
          plugins: { legend: { labels: { boxWidth: 10 } } },
        },
      });

      rocPointDataset = {
        type: "scatter",
        label: "Your condition",
        data: [],
        pointRadius: 5,
        pointHoverRadius: 6,
      };

      rocChart = new Chart(ctxRoc, {
        type: "line",
        data: {
          datasets: [
            { label: "Vz ISA", data: rocISA, tension: 0.2 },
            { label: "Vz ISA+10", data: rocISA10, tension: 0.2 },
            { label: "Vz ISA+20", data: rocISA20, tension: 0.2 },
            rocPointDataset,
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { type: "linear", title: { display: true, text: "Pressure altitude (ft)" } },
            y: { title: { display: true, text: "Rate of climb (ft/min)" } },
          },
          plugins: { legend: { labels: { boxWidth: 10 } } },
        },
      });
    }

    // Helper to set summary line text & colour
    function setSummaryLine(id, text, ok) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.classList.toggle("summary-line-ok", ok);
      el.classList.toggle("summary-line-bad", !ok);
    }

    // ------- Main calc -------
    function calculateAll() {
      // W&B
      const emptyWeight = parseFloat(document.getElementById("emptyWeight").value) || 0;
      const emptyArm    = parseFloat(document.getElementById("emptyArm").value) || 0;
      const pilotWt     = parseFloat(document.getElementById("pilotWt").value) || 0;
      const pilotArm    = parseFloat(document.getElementById("pilotArm").value) || 0;
      const paxWt       = parseFloat(document.getElementById("paxWt").value) || 0;
      const paxArm      = parseFloat(document.getElementById("paxArm").value) || 0;
      const bagWt       = parseFloat(document.getElementById("bagWt").value) || 0;
      const bagArm      = 1580;
      const fuelL       = parseFloat(document.getElementById("fuelL").value) || 0;
      const fuelDensity = parseFloat(document.getElementById("fuelDensity").value) || 0.72;

      const fuelKg = fuelL * fuelDensity;
      document.getElementById("fuelKg").value = round(fuelKg, 1);

      const fuelWarn = document.getElementById("fuelWarn");
      if (fuelKg > MAX_FUEL_KG || fuelL > MAX_FUEL_L) {
        fuelWarn.style.display = "block";
        fuelWarn.textContent = `Fuel exceeds AFM limit (${MAX_FUEL_KG} kg / ${MAX_FUEL_L} L).`;
      } else fuelWarn.style.display = "none";

      const bagWarn = document.getElementById("bagWarn");
      if (bagWt > MAX_BAG_KG) {
        bagWarn.style.display = "block";
        bagWarn.textContent = `Baggage exceeds AFM limit (${MAX_BAG_KG} kg).`;
      } else bagWarn.style.display = "none";

      function moment(mass, arm) { return mass * arm; }

      const mEmpty = emptyWeight;
      const mPilot = pilotWt;
      const mPax   = paxWt;
      const mBag   = bagWt;
      const mFuel  = fuelKg;

      const momEmpty = moment(mEmpty, emptyArm);
      const momPilot = moment(mPilot, pilotArm);
      const momPax   = moment(mPax, paxArm);
      const momBag   = moment(mBag, bagArm);
      const momFuel  = moment(mFuel, 774);

      const massTO = mEmpty + mPilot + mPax + mBag + mFuel;
      const momTO  = momEmpty + momPilot + momPax + momBag + momFuel;
      const cgTO   = momTO / (massTO || 1);

      const massLW = mEmpty + mPilot + mPax + mBag;
      const momLW  = momEmpty + momPilot + momPax + momBag;
      const cgLW   = momLW / (massLW || 1);

      document.getElementById("tow").textContent   = round(massTO, 1);
      document.getElementById("cg").textContent    = isFinite(cgTO) ? round(cgTO, 0) : "–";
      document.getElementById("lw").textContent    = round(massLW, 1);
      document.getElementById("cgArr").textContent = isFinite(cgLW) ? round(cgLW, 0) : "–";

      const wbStatusPill = document.getElementById("wbStatusPill");

      const massOkTO  = massTO <= MAX_MASS && massTO >= CG_MIN_MASS;
      const massOkLW  = massLW <= MAX_MASS && massLW >= CG_MIN_MASS;
      const cgBasicTO = cgTO >= CG_MIN && cgTO <= CG_MAX;
      const cgBasicLW = cgLW >= CG_MIN && cgLW <= CG_MAX;

      const insidePolyTO = pointInPoly(cgTO, massTO, CG_POLY);
      const insidePolyLW = pointInPoly(cgLW, massLW, CG_POLY);

      const fuelOk = fuelKg <= MAX_FUEL_KG && fuelL <= MAX_FUEL_L;
      const bagOk  = mBag <= MAX_BAG_KG;

      const wbOk =
        massOkTO && massOkLW &&
        cgBasicTO && cgBasicLW &&
        insidePolyTO && insidePolyLW &&
        fuelOk && bagOk;

      if (wbOk) {
        wbStatusPill.textContent = "All points inside AFM envelope and limits";
        wbStatusPill.classList.remove("bad");
        wbStatusPill.classList.add("ok");
      } else {
        wbStatusPill.textContent = "Check W&B – outside AFM limits";
        wbStatusPill.classList.remove("ok");
        wbStatusPill.classList.add("bad");
      }

      // Update CG chart
      if (cgDepDataset && cgArrDataset) {
        cgDepDataset.data = (isFinite(cgTO) && isFinite(massTO)) ? [{ x: cgTO, y: massTO }] : [];
        cgArrDataset.data = (isFinite(cgLW) && isFinite(massLW)) ? [{ x: cgLW, y: massLW }] : [];
        cgChart.update();
      }

      // Atmosphere
      const fieldElev = parseFloat(document.getElementById("fieldElev").value) || 0;
      const oat       = parseFloat(document.getElementById("oat").value) || 0;
      const surface   = document.getElementById("surface").value;
      const runwayLen = parseFloat(document.getElementById("runwayLen").value) || 1;

      const pa     = fieldElev; // approx PA
      const isaTemp = 15 - 2 * (pa / 1000);
      const isaDev  = oat - isaTemp;

      document.getElementById("pa").value     = round(pa, 0);
      document.getElementById("isaDev").value = round(isaDev, 1);

      // Wind
      const rwHeading = parseFloat(document.getElementById("rwHeading").value) || 0;
      const windDir   = parseFloat(document.getElementById("windDir").value) || 0;
      const windSpd   = parseFloat(document.getElementById("windSpd").value) || 0;

      const angleRad  = ((windDir - rwHeading) * Math.PI) / 180;
      const headwind  = windSpd * Math.cos(angleRad);
      const crosswind = windSpd * Math.sin(angleRad);
      const tailwind  = headwind < 0 ? -headwind : 0;

      const windComponentsEl = document.getElementById("windComponents");
      const windLimitWarn    = document.getElementById("windLimitWarn");

      const headStr =
        headwind >= 0
          ? `Headwind ${round(headwind, 1)} kt`
          : `Tailwind ${round(tailwind, 1)} kt`;
      const xwStr = `Crosswind ${round(Math.abs(crosswind), 1)} kt`;

      let xwWarn = "";
      if (Math.abs(crosswind) > MAX_XWIND) {
        xwWarn = " – ABOVE max demonstrated 18 kt";
      } else {
        xwWarn = " – within demonstrated limit";
      }

      windComponentsEl.textContent = `${headStr}, ${xwStr}${xwWarn}`;

      const windOk = windSpd <= MAX_WIND && Math.abs(crosswind) <= MAX_XWIND;

      if (windSpd > MAX_WIND) {
        windLimitWarn.style.display = "block";
        windLimitWarn.textContent = `Departure not permitted – total wind speed ${round(windSpd,1)} kt exceeds 40 kt limit.`;
      } else {
        windLimitWarn.style.display = "none";
      }

      // Performance
      const baseTO  = interpTOLD(pa, isaDev, TO_TABLE);
      const baseLDG = interpTOLD(pa, isaDev, LDG_TABLE);
      const grass   = GRASS_FACTORS[surface] || GRASS_FACTORS.hard;

      const toRun  = baseTO.run * grass.to;
      const toDist = baseTO.dist;
      const ldgRun = baseLDG.run * grass.ldg;
      const ldgDist = baseLDG.dist;

      document.getElementById("toRun").textContent  = round(toRun, 0);
      document.getElementById("toDist").textContent = round(toDist, 0);
      document.getElementById("ldgRun").textContent = round(ldgRun, 0);
      document.getElementById("ldgDist").textContent = round(ldgDist, 0);

      const roc = interpRoc(pa, isaDev);
      document.getElementById("roc").textContent = round(roc, 0);

      // Regulatory factors
      const reqTora125 = toDist * 1.25;       // no stopway case
      const reqToraRun = toRun;               // with stopway: TORA >= AFM run
      const reqToda115 = toDist * 1.15;       // TODA >= 1.15 * AFM distance
      const reqAsda130 = toRun * 1.3;         // ASDA >= 1.3 * AFM run

      const reqLdaDry = ldgDist / 0.7;        // AFM must fit in 70% LDA
      const reqLdaWet = ldgDist * 1.15 / 0.7; // plus 1.15 factor for wet

      // Populate numbers
      document.getElementById("reqTora125").textContent = round(reqTora125, 0);
      document.getElementById("reqToraRun").textContent = round(reqToraRun, 0);
      document.getElementById("reqToda115").textContent = round(reqToda115, 0);
      document.getElementById("reqAsda130").textContent = round(reqAsda130, 0);

      document.getElementById("reqLdaDry").textContent = round(reqLdaDry, 0);
      document.getElementById("reqLdaWet").textContent = round(reqLdaWet, 0);

      // Status vs runway
      function statusSpan(elId, ok) {
        const el = document.getElementById(elId);
        el.textContent = ok ? "OK" : "NOT OK";
        el.className = ok ? "fact-status-ok" : "fact-status-bad";
      }

      const tora125Ok   = reqTora125 <= runwayLen;
      const toraRunOk   = reqToraRun <= runwayLen;
      const toda115Ok   = reqToda115 <= runwayLen;
      const asda130Ok   = reqAsda130 <= runwayLen;
      const stopwayOk   = toraRunOk && toda115Ok && asda130Ok;

      const ldaDryOk    = reqLdaDry <= runwayLen;
      const ldaWetOk    = reqLdaWet <= runwayLen;

      statusSpan("reqTora125Status", tora125Ok);
      statusSpan("reqStopwayStatus", stopwayOk);
      statusSpan("reqLdaDryStatus", ldaDryOk);
      statusSpan("reqLdaWetStatus", ldaWetOk);

      // Charts markers
      if (toPointDataset && ldgPointDataset && rocPointDataset) {
        toPointDataset.data  = [{ x: pa, y: baseTO.run }];
        ldgPointDataset.data = [{ x: pa, y: baseLDG.run }];
        rocPointDataset.data = [{ x: pa, y: roc }];
        toChart.update();
        ldgChart.update();
        rocChart.update();
      }

      // Runway bar
      const bar = document.getElementById("runwayBar");
      const barWidth = bar.clientWidth || 1;

      function setMarker(id, dist) {
        const el = document.getElementById(id);
        const ratio = dist / runwayLen;
        const widthPx = Math.min(barWidth, Math.max(0, ratio * barWidth));
        el.style.left  = "0px";
        el.style.width = widthPx + "px";
        if (dist > runwayLen) el.classList.add("overrun");
        else el.classList.remove("overrun");
      }

      setMarker("barToRun",  toRun);
      setMarker("barToDist", toDist);
      setMarker("barLdgRun", ldgRun);
      setMarker("barLdgDist", ldgDist);

      // ------- Operational summary -------
      const sumWbText = wbOk
        ? `OK – TOW ${round(massTO,1)} kg at ${round(cgTO,0)} mm; landing weight ${round(massLW,1)} kg at ${round(cgLW,0)} mm. Fuel and baggage within AFM limits.`
        : `NOT OK – check masses, CG envelope, fuel (≤ ${MAX_FUEL_KG} kg / ${MAX_FUEL_L} L) and baggage (≤ ${MAX_BAG_KG} kg).`;
      setSummaryLine("sumWb", sumWbText, wbOk);

      const toOk = tora125Ok; // main criterion for no-stopway case
      const sumPerfToText = toOk
        ? `OK – AFM T/O distance to 15 m = ${round(toDist,0)} m; required TORA (×1.25) = ${round(reqTora125,0)} m ≤ available ${round(runwayLen,0)} m.`
        : `NOT OK – required TORA (AFM 15 m ×1.25 = ${round(reqTora125,0)} m) exceeds available ${round(runwayLen,0)} m.`;
      setSummaryLine("sumPerfTo", sumPerfToText, toOk);

      // Decide which landing requirement to emphasise: dry vs wet
      const usingWet = (surface === "grass_wet");
      const ldgCriterionOk = usingWet ? ldaWetOk : ldaDryOk;
      const sumPerfLdgText = usingWet
        ? (ldgCriterionOk
          ? `OK – AFM landing distance = ${round(ldgDist,0)} m; required LDA wet (×1.15 ÷0.7) = ${round(reqLdaWet,0)} m ≤ available ${round(runwayLen,0)} m.`
          : `NOT OK – required LDA wet (AFM ×1.15 ÷0.7 = ${round(reqLdaWet,0)} m) exceeds available ${round(runwayLen,0)} m.`)
        : (ldgCriterionOk
          ? `OK – AFM landing distance = ${round(ldgDist,0)} m; required LDA dry (÷0.7) = ${round(reqLdaDry,0)} m ≤ available ${round(runwayLen,0)} m.`
          : `NOT OK – required LDA dry (AFM ÷0.7 = ${round(reqLdaDry,0)} m) exceeds available ${round(runwayLen,0)} m.`);
      setSummaryLine("sumPerfLdg", sumPerfLdgText, ldgCriterionOk);

      const sumWindText = windOk
        ? `OK – ${headStr}, ${xwStr}; total wind ${round(windSpd,1)} kt ≤ 40 kt and crosswind within 18 kt demonstrated.`
        : `NOT OK – wind limits exceeded (total ${round(windSpd,1)} kt, crosswind ${round(Math.abs(crosswind),1)} kt; limit 40 kt and 18 kt crosswind).`;
      setSummaryLine("sumWind", sumWindText, windOk);

      const runwayOk = toOk && ldgCriterionOk;
      const sumRunwayText = runwayOk
        ? `Runway 13/31 full length (1330 m) sufficient for both take-off and landing under the current factors.`
        : `Runway distance limiting – one or more required distances exceed the 1330 m available.`;
      setSummaryLine("sumRunway", sumRunwayText, runwayOk);

      // Overall decision
      const go = wbOk && windOk && runwayOk;
      const reasons = [];
      if (!wbOk) reasons.push("W&B outside AFM limits");
      if (!toOk) reasons.push("take-off distance requirement not met");
      if (!ldgCriterionOk) reasons.push("landing distance requirement not met");
      if (!windOk) reasons.push("wind limits exceeded");

      const pill = document.getElementById("sumPill");
      if (go) {
        pill.textContent = "Decision: GO – all checks satisfied (still apply judgement & margins).";
        pill.classList.remove("bad");
        pill.classList.add("ok");
      } else {
        pill.textContent = "Decision: NO-GO – " + reasons.join("; ");
        pill.classList.remove("ok");
        pill.classList.add("bad");
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      buildCGChart();
      buildPerfCharts();

      document.getElementById("calcBtn").addEventListener("click", calculateAll);

      // Registration selector behaviour
      const regSelect = document.getElementById("regSelect");
      const regInfo   = document.getElementById("regInfo");

      regSelect.addEventListener("change", () => {
        const reg = regSelect.value;
        const data = REG_DATA[reg];
        if (data) {
          document.getElementById("emptyWeight").value = data.weight;
          document.getElementById("emptyArm").value    = data.cg;
          regInfo.textContent = `${reg}: empty mass ${data.weight} kg, empty CG ${data.cg} mm.`;
        } else {
          regInfo.textContent = "Custom/manual – enter empty mass and CG from the aircraft documents.";
        }
        calculateAll();
      });

      calculateAll();
      window.addEventListener("resize", calculateAll);
    });
  </script>
</body>
</html>
